
params {

    // General

    // Mandatory parameters 
    target_region = "16S" // "16S", "18S", "ITS"
    raw_R1_suffix = "_R1_raw.fastq.gz"
    raw_R2_suffix = "_R2_raw.fastq.gz"
    raw_reads_dir = "${baseDir}/raw_reads/"
    trim_primers = true
    

    // -------- Mandatory if not using GLDS_accession ---------------------------------//
    csv_file = "${baseDir}/PE_file.csv" // A 3-column (single-end) or 4-column (paired-end) input file ( "sample_id", "forward", ["reverse",] "paired")

    // Mandatory if you want to visualize your result
    enable_visualizations = true
    // a 4-column file with these exact headers [ "Sample Name", "read1_path", "raw_R1_suffix", "groups"]
    // withouth the brackets, quotations and commas ofcourse.
    runsheet  = "${baseDir}/test_runsheet.csv"    

    // -------- End of Mandatory if not using GLDS_accession ---------------------------------//

    // Cutadapt parameters
    min_cutadapt_len = 130
    primers_linked = "TRUE"
    discard_untrimmed = "TRUE"
    F_primer = "GTGCCAGCMGCCGCGGTAA"
    R_primer = "GGACTACHVGGGTWTCTAA"

    // Dada2 parameters
    left_trunc = 0
    right_trunc = 0
    left_maxEE = 1
    right_maxEE = 1
    trim_primers =  "TRUE"
    concatenate_reads_only = "FALSE"

    // If using conda environments specify their locations so new ones won't be created
    conda{
          // Specify the paths to your existing conda environments
          // Set to an empty string or any Groovy falsely value
          // if you want to create a new conda environment
          genelab = "/global/smf/miniconda38_admin/envs/genelab-utils"
          qc = "/global/smf/miniconda38_admin/envs/0cfc5326c03a4539e0d0ba4979917a9f_"
          R = "/global/smf/miniconda38_admin/envs/cb8bcbd7fc9c69ad9bcb3b53e9855682"
          R_visualizations = "/global/smf/miniconda38_admin/envs/AmpIllumina-R-visualizations_20240416"
          cutadapt = "/global/smf/miniconda38_admin/envs/7a56bd9a4a94941a5986a549cf328e7d"
      }


    // Mandatory parameters  if using GLDS_accession
    GLDS_accession = false
 
    assay_suffix = "GLAmpSeq"
    output_prefix = ""
    publishDir_mode = "copy" // "link", "copy"

    // Suffixes
    primer_trimmed_R1_suffix = "_R1_trimmed.fastq.gz"
    primer_trimmed_R2_suffix =  "_R2_trimmed.fastq.gz"
    filtered_R1_suffix = "_R1_filtered.fastq.gz"
    filtered_R2_suffix = "_R2_filtered.fastq.gz"


    // directories
    fastqc_out_dir = "${baseDir}/workflow_output/FastQC_Outputs/"
    trimmed_reads_dir = "${baseDir}/workflow_output/Trimmed_Sequence_Data/"
    filtered_reads_dir = "${baseDir}/workflow_output/Filtered_Sequence_Data/"
    info_out_dir = "${baseDir}/workflow_output/Metadata/"
    plots_dir =  "${baseDir}/workflow_output/Final_Outputs/Plots/"
    final_outputs_dir = "${baseDir}/workflow_output/Final_Outputs/"


    // Multiqc
    multiqc_config ="${baseDir}/config/multiqc.config"

    errorStrategy = "ignore"
    executor = "slurm"
}




profiles {

    conda {   
        conda.enabled = true               
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.cacheDir = "/global/data/temp_scratch/oobayomi/amplicon/illuminav2/singularity/"
    }

    docker {
        docker.enabled         = true
        docker.runOptions      = '-u $(id -u):$(id -g)'
        docker.userEmulation   = true
    }

}


process {

    errorStrategy = { params.errorStrategy ? params.errorStrategy : "ignore" } 
    executor = 'slurm' //{ params.executor ? params.executor : "local" }
    queue = "normal,priority"
    //process.queueSize = 32 // how many jobs should be submitted at one time
    maxRetries = 2
    cpus = 2
    memory = '5 GB'
    cache = 'lenient'
  //debug = true  // uncomment to see what is being emitted to the standard output


    withName: GET_RUNSHEET {
                  conda = {params.conda.genelab ? params.conda.genelab : "envs/genelab.yaml"}
                  container = "olabiyi/genelab-utils:1.3.22"
                  publishDir = [path: params.raw_reads_dir, mode: params.publishDir_mode]
            }

    withLabel: fastqc {
                  conda = {params.conda.qc ? params.conda.qc : "envs/qc.yaml"}
                  container = "staphb/fastqc:0.12.1"
            }

    withName: RAW_FASTQC {                  
                  publishDir = [path: params.raw_reads_dir, mode: params.publishDir_mode]
            }

    withName: "RAW_MULTIQC|TRIMMED_MULTIQC" {
                  conda = {params.conda.qc ? params.conda.qc : "envs/qc.yaml"}
                  container = "staphb/multiqc:1.19"
                  publishDir = [path: params.fastqc_out_dir, mode: params.publishDir_mode]
            }

    withName: "CUTADAPT|COMBINE_CUTADAPT_LOGS_AND_SUMMARIZE" {
                  conda = {params.conda.cutadapt ?  params.conda.cutadapt : "envs/cutadapt.yaml"}
                  container = "zavolab/cutadapt:1.16"
                  memory = "10 GB"
                  publishDir = [path: params.trimmed_reads_dir, mode: params.publishDir_mode]
            }
           
    withName: TRIMMED_FASTQC {
                  publishDir = [path: params.filtered_reads_dir, mode: params.publishDir_mode ]
            } 

    withName: "RUN_R_TRIM|RUN_R_NOTRIM" {
                  conda = {params.conda.R ?  params.conda.R : "envs/R.yaml"}
                  container = "olabiyi/r-dada-decipher-biomformat:1.0"
                  memory = "200 GB"
                  cpus = 10
                  publishDir = [[path: params.filtered_reads_dir, pattern: "Filtered_Sequence_Data/*.gz",
                                mode: params.publishDir_mode, saveAs: { fn -> fn.substring(fn.lastIndexOf('/')+1)}],
                                [path: params.final_outputs_dir , pattern: "final_outputs/*.{tsv,biom,fasta}",
                                mode: params.publishDir_mode, saveAs: { fn -> fn.substring(fn.lastIndexOf('/')+1)}]] 
          }

    withName: ZIP_BIOM {
                  conda = {params.conda.qc ? params.conda.qc : "envs/qc.yaml"}
                  container = "staphb/multiqc:1.19"
                  publishDir = [path: "${params.final_outputs_dir}${params.output_prefix}", mode: params.publishDir_mode]
            }

    withName: R_VISUALIZATION {
                  conda = {params.conda.R_visualizations ? params.conda.R_visualizations : "envs/R_visualizations.yaml"}
                  container = "olabiyi/r-tidyverse-vegan-deseq2-phyloseq:1.0"
                  memory = '20 GB'
                  cpus = 10
                  publishDir = [path: "${params.plots_dir}${params.output_prefix}", 
                               mode: params.publishDir_mode, saveAs: { fn -> fn.substring(fn.indexOf('/')+1)}]
            }


}



// Adapted from : https://github.com/nf-core/rnaseq/blob/master/nextflow.config
def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.final_outputs_dir}/Resource_Usage/execution_timeline_${trace_timestamp}.html"
}
report {
    enabled = true
    file    = "${params.final_outputs_dir}/Resource_Usage/execution_report_${trace_timestamp}.html"
}
trace {
    enabled = true
    file    = "${params.final_outputs_dir}/Resource_Usage/execution_trace_${trace_timestamp}.txt"
}
dag {
    enabled = false // TODO: DISCUSS, setting up nextflow env with graphviz to output the svg diagram
    file    = "${params.final_outputs_dir}/Resource_Usage/pipeline_dag_${trace_timestamp}.svg"
}

manifest {
    author = 'Olabiyi Aderemi Obayomi, Mike Lee'
    homePage = 'https://github.com/nasa/GeneLab_Data_Processing/blob/master/Amplicon/'
    description = 'GeneLab bioinformatics processing pipelines for amplicon sequencing data'
    mainScript = 'main.nf'
    defaultBranch = 'main'
    nextflowVersion = '>=22.10.1'
    version = '1.0.0'
}


